#!/usr/bin/env node

// @ts-check

require('esbuild-runner').install({
  type: 'transform',
});

const { join } = require('path');
const { generateAllConfigs } = require('../src/circleci');
const { getWorkspacePackageInfo } = require('../src/pnpm');
const { writeFileSync } = require('fs');

const workspaceRoot = join(__dirname, '..', '..', '..');

async function main() {
  const packageInfo = await getWorkspacePackageInfo(workspaceRoot);
  const configs = await generateAllConfigs(packageInfo);
  for (const [filePath, fileContents] of configs.entries()) {
    console.log(`Writing CircleCI config to ${filePath}`);
    writeFileSync(filePath, fileContents);
  }
}

main().catch((error) => {
  console.error(error);
  process.exit(1);
});
