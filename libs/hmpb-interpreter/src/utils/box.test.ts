import { LineSegment } from '@votingworks/lsd'
import { findBoxes, findRotation, inferBoxFromPartial } from './box'

const slightlyCounterClockwiseRotatedBallotLineSegments: readonly LineSegment[] = [
  {
    x1: 820.5006018719415,
    y1: 166.6786431868848,
    x2: 67.48893455613222,
    y2: 169.21563663262248,
    width: 11.112380814731765,
  },
  {
    x1: 2437.491332000693,
    y1: 812.8177420933071,
    x2: 1681.4959453310769,
    y2: 816.7130826718886,
    width: 10.097369409595514,
  },
  {
    x1: 2434.511214681616,
    y1: 93.4487238200447,
    x2: 1678.501723424372,
    y2: 97.7994715535103,
    width: 10.411479314966641,
  },
  {
    x1: 2443.5132345457196,
    y1: 1605.6318934515161,
    x2: 1690.5050065376986,
    y2: 1610.3064806424175,
    width: 10.865340372045514,
  },
  {
    x1: 1681.507402462926,
    y1: 806.8602512259685,
    x2: 2437.5176649835335,
    y2: 802.7460568526078,
    width: 10.763042851468096,
  },
  {
    x1: 1687.494639323475,
    y1: 1599.6840215341524,
    x2: 2446.521006386473,
    y2: 1594.6974992199,
    width: 10.990360689396315,
  },
  {
    x1: 1678.5093870722783,
    y1: 87.15502569237927,
    x2: 2437.519000898896,
    y2: 82.85003022445933,
    width: 10.89381228014957,
  },
  {
    x1: 1588.5229238078882,
    y1: 4197.515550465026,
    x2: 2539.570502301746,
    y2: 4186.698836936847,
    width: 11.723681666421577,
  },
  {
    x1: 896.2747970658731,
    y1: 3760.4912116697324,
    x2: 886.8486397604029,
    y2: 2929.46201721269,
    width: 8.318899804991322,
  },
  {
    x1: 1683.2684434263529,
    y1: 1552.508751235975,
    x2: 1677.9815158083416,
    y2: 808.4823667618039,
    width: 9.154758958055695,
  },
  {
    x1: 418.50100608070136,
    y1: 3946.577594732218,
    x2: 2260.541412857623,
    y2: 3922.6939978504797,
    width: 8.440050907084311,
  },
  {
    x1: 904.5067278284995,
    y1: 3758.0427581675644,
    x2: 1654.5402315195179,
    y2: 3748.745621646442,
    width: 8.280675366193128,
  },
  {
    x1: 1699.4971498333841,
    y1: 2344.15723158181,
    x2: 2449.4951846588706,
    y2: 2337.9208946056424,
    width: 7.945467558773661,
  },
  {
    x1: 1646.1568405306705,
    y1: 2866.5165777563,
    x2: 1626.6085070180516,
    y2: 103.48508240008408,
    width: 8.864483762923188,
  },
  {
    x1: 1693.491463715755,
    y1: 1551.26024408012,
    x2: 2440.5180166617743,
    y2: 1546.1166259756878,
    width: 7.9208543311385515,
  },
  {
    x1: 2450.313176322612,
    y1: 2335.5234529993604,
    x2: 2442.5269139921934,
    y2: 1609.5104360428115,
    width: 10.712421517869533,
  },
  {
    x1: 2518.34482187189,
    y1: 694.4768985650369,
    x2: 2515.6058086585376,
    y2: 1.487724410032456,
    width: 11.810189586594122,
  },
  {
    x1: 2260.505505364432,
    y1: 3928.92597077958,
    x2: 418.4642388185541,
    y2: 3952.733022713293,
    width: 7.608628451998863,
  },
  {
    x1: 1660.5417125685356,
    y1: 3754.82006339154,
    x2: 898.4735472651769,
    y2: 3764.3945253295324,
    width: 7.891018954982878,
  },
  {
    x1: 1690.1464238047506,
    y1: 1615.4814717908282,
    x2: 1695.229505334599,
    y2: 2341.508895019335,
    width: 7.778070545356606,
  },
  {
    x1: 1655.3577773550999,
    y1: 3121.486833680842,
    x2: 1665.028412481352,
    y2: 3751.522587902121,
    width: 8.248503805997101,
  },
  {
    x1: 1648.5110279143646,
    y1: 2876.6388020259965,
    x2: 889.4660024677476,
    y2: 2883.989231115895,
    width: 7.132668457148901,
  },
  {
    x1: 2534.2617390401715,
    y1: 2584.5192360837445,
    x2: 2527.660987305213,
    y2: 1816.4728338126743,
    width: 11.655180334444955,
  },
  {
    x1: 1648.524286249582,
    y1: 2928.98041544292,
    x2: 889.5089304421041,
    y2: 2936.412088399345,
    width: 10.027595600186013,
  },
  {
    x1: 1627.5187803361373,
    y1: 98.10885756305142,
    x2: 871.5080302468349,
    y2: 102.04310427738511,
    width: 10.014635826063673,
  },
  {
    x1: 868.5126499996604,
    y1: 91.19199899725565,
    x2: 1630.5099211838153,
    y2: 87.61128992879047,
    width: 10.677464416195766,
  },
  {
    x1: 889.4915228714455,
    y1: 2925.608875272238,
    x2: 1651.536716334071,
    y2: 2918.3596599064226,
    width: 10.829430470236543,
  },
  {
    x1: 2448.735826128098,
    y1: 1597.508016512272,
    x2: 2456.5408373229293,
    y2: 2341.52055245831,
    width: 8.779217917274643,
  },
  {
    x1: 1632.754396688906,
    y1: 91.48423021210681,
    x2: 1652.208210110272,
    y2: 2872.537016734697,
    width: 9.961448158902472,
  },
  {
    x1: 2446.500300440947,
    y1: 1552.5495275780343,
    x2: 1687.4918336180572,
    y2: 1557.153774984028,
    width: 7.416602452624465,
  },
  {
    x1: 2452.499117297087,
    y1: 2344.3912204906956,
    x2: 1693.4760651070187,
    y2: 2350.5503938795678,
    width: 7.898557876490415,
  },
  {
    x1: 1684.445079615649,
    y1: 820.4805641905781,
    x2: 1689.256106623824,
    y2: 1549.4884107195326,
    width: 8.306880291550925,
  },
  {
    x1: 70.49876829883952,
    y1: 94.08800736965732,
    x2: 820.5100025467126,
    y2: 91.84575923332966,
    width: 13.381144363900539,
  },
  {
    x1: 1681.5190224982275,
    y1: 103.48956662157144,
    x2: 1683.7895441435658,
    y2: 760.4920876109758,
    width: 8.046129167581746,
  },
  {
    x1: 2434.7676831896315,
    y1: 751.5004926999152,
    x2: 2435.9714369756784,
    y2: 97.50270833919126,
    width: 8.966853860493707,
  },
  {
    x1: 884.1477838414106,
    y1: 2881.4956402912408,
    x2: 865.3906408803077,
    y2: 94.48054543574523,
    width: 9.225287484105005,
  },
  {
    x1: 895.4927006364431,
    y1: 2877.715907107584,
    x2: 1645.4835598516208,
    y2: 2870.734009938806,
    width: 8.038390511882781,
  },
  {
    x1: 1658.5433079655695,
    y1: 3745.5269838241475,
    x2: 1647.331455546988,
    y2: 2932.516114849692,
    width: 9.846622167930981,
  },
  {
    x1: 1677.557577504858,
    y1: 760.5037395585036,
    x2: 1674.902914344527,
    y2: 91.49046516947857,
    width: 8.65454235351924,
  },
  {
    x1: 1687.4916332694052,
    y1: 758.7540227504803,
    x2: 2431.503300328144,
    y2: 755.1887155969506,
    width: 7.878580520808542,
  },
  {
    x1: 1689.0343639495552,
    y1: 2347.4888736275866,
    x2: 1683.6392490020264,
    y2: 1603.4844873303437,
    width: 9.110635020882984,
  },
  {
    x1: 871.5078899049498,
    y1: 106.49994718118222,
    x2: 890.0450177750222,
    y2: 2875.5164348315097,
    width: 9.002416003602853,
  },
  {
    x1: 892.8890784603417,
    y1: 2941.460797551534,
    x2: 902.2936313268746,
    y2: 3754.4908198374405,
    width: 7.819613444929571,
  },
  {
    x1: 2437.502904598328,
    y1: 761.0541095526223,
    x2: 1681.4922265333805,
    y2: 765.0170575672302,
    width: 7.116431335773745,
  },
]

test('findRotation', () => {
  expect(
    findRotation([{ x1: 0, y1: 0, x2: 0, y2: 1, width: 1 }])?.angle
  ).toEqual(0)
  expect(
    findRotation([
      { x1: 10, y1: 10, x2: 11, y2: 20, width: 1 },
      { x1: 10, y1: 10, x2: 20, y2: 9, width: 1 },
    ])?.angle
  ).toBeCloseTo(Math.PI / 2 - Math.atan2(10, -1))
})

test('findRotation with lots of segments', () => {
  expect(
    findRotation(slightlyCounterClockwiseRotatedBallotLineSegments)?.angle
  ).toBeCloseTo(-0.00785)
})

test('findBoxes', () => {
  expect(
    findBoxes(slightlyCounterClockwiseRotatedBallotLineSegments, {
      maxConnectedCornerDistance: 0.01 * 2544,
      parallelThreshold: 2 * 2544,
    })
  ).toMatchInlineSnapshot(`
    Set {
      Object {
        "bottom": Object {
          "width": 7.891018954982878,
          "x1": 1660.5417125685356,
          "x2": 898.4735472651769,
          "y1": 3754.82006339154,
          "y2": 3764.3945253295324,
        },
        "left": Object {
          "width": 8.318899804991322,
          "x1": 896.2747970658731,
          "x2": 886.8486397604029,
          "y1": 3760.4912116697324,
          "y2": 2929.46201721269,
        },
        "right": Object {
          "width": 8.248503805997101,
          "x1": 1655.3577773550999,
          "x2": 1665.028412481352,
          "y1": 3121.486833680842,
          "y2": 3751.522587902121,
        },
        "top": Object {
          "width": 10.829430470236543,
          "x1": 889.4915228714455,
          "x2": 1651.536716334071,
          "y1": 2925.608875272238,
          "y2": 2918.3596599064226,
        },
      },
      Object {
        "bottom": Object {
          "width": 7.898557876490415,
          "x1": 2452.499117297087,
          "x2": 1693.4760651070187,
          "y1": 2344.3912204906956,
          "y2": 2350.5503938795678,
        },
        "left": Object {
          "width": 9.110635020882984,
          "x1": 1689.0343639495552,
          "x2": 1683.6392490020264,
          "y1": 2347.4888736275866,
          "y2": 1603.4844873303437,
        },
        "right": Object {
          "width": 8.779217917274643,
          "x1": 2448.735826128098,
          "x2": 2456.5408373229293,
          "y1": 1597.508016512272,
          "y2": 2341.52055245831,
        },
        "top": Object {
          "width": 10.990360689396315,
          "x1": 1687.494639323475,
          "x2": 2446.521006386473,
          "y1": 1599.6840215341524,
          "y2": 1594.6974992199,
        },
      },
      Object {
        "bottom": Object {
          "width": 7.116431335773745,
          "x1": 2437.502904598328,
          "x2": 1681.4922265333805,
          "y1": 761.0541095526223,
          "y2": 765.0170575672302,
        },
        "left": Object {
          "width": 8.65454235351924,
          "x1": 1677.557577504858,
          "x2": 1674.902914344527,
          "y1": 760.5037395585036,
          "y2": 91.49046516947857,
        },
        "right": undefined,
        "top": Object {
          "width": 10.89381228014957,
          "x1": 1678.5093870722783,
          "x2": 2437.519000898896,
          "y1": 87.15502569237927,
          "y2": 82.85003022445933,
        },
      },
      Object {
        "bottom": Object {
          "width": 7.416602452624465,
          "x1": 2446.500300440947,
          "x2": 1687.4918336180572,
          "y1": 1552.5495275780343,
          "y2": 1557.153774984028,
        },
        "left": Object {
          "width": 9.154758958055695,
          "x1": 1683.2684434263529,
          "x2": 1677.9815158083416,
          "y1": 1552.508751235975,
          "y2": 808.4823667618039,
        },
        "right": undefined,
        "top": Object {
          "width": 10.763042851468096,
          "x1": 1681.507402462926,
          "x2": 2437.5176649835335,
          "y1": 806.8602512259685,
          "y2": 802.7460568526078,
        },
      },
      Object {
        "bottom": Object {
          "width": 7.132668457148901,
          "x1": 1648.5110279143646,
          "x2": 889.4660024677476,
          "y1": 2876.6388020259965,
          "y2": 2883.989231115895,
        },
        "left": Object {
          "width": 9.225287484105005,
          "x1": 884.1477838414106,
          "x2": 865.3906408803077,
          "y1": 2881.4956402912408,
          "y2": 94.48054543574523,
        },
        "right": Object {
          "width": 9.961448158902472,
          "x1": 1632.754396688906,
          "x2": 1652.208210110272,
          "y1": 91.48423021210681,
          "y2": 2872.537016734697,
        },
        "top": Object {
          "width": 10.677464416195766,
          "x1": 868.5126499996604,
          "x2": 1630.5099211838153,
          "y1": 91.19199899725565,
          "y2": 87.61128992879047,
        },
      },
    }
  `)
})

test('findBoxes joining segments on the same side', () => {
  expect(
    findBoxes(
      [
        // top
        { x1: 0, y1: 0, x2: 10, y2: 0, width: 1 },
        // partial right at top
        { x1: 10, y1: 0, x2: 10, y2: 3, width: 1 },
        // partial right at bottom
        { x1: 10, y1: 7, x2: 10, y2: 10, width: 1 },
        // bottom
        { x1: 10, y1: 10, x2: 0, y2: 10, width: 1 },
        // left
        { x1: 0, y1: 10, x2: 0, y2: 0, width: 1 },
      ],
      {
        maxConnectedCornerDistance: 1,
        parallelThreshold: 10,
      }
    )
  ).toMatchInlineSnapshot(`
    Set {
      Object {
        "bottom": Object {
          "width": 1,
          "x1": 10,
          "x2": 0,
          "y1": 10,
          "y2": 10,
        },
        "left": Object {
          "width": 1,
          "x1": 0,
          "x2": 0,
          "y1": 10,
          "y2": 0,
        },
        "right": Object {
          "width": 1,
          "x1": 10,
          "x2": 10,
          "y1": 0,
          "y2": 10,
        },
        "top": Object {
          "width": 1,
          "x1": 0,
          "x2": 10,
          "y1": 0,
          "y2": 0,
        },
      },
    }
  `)
})

test('infer one box side', () => {
  const top = { x1: 1, y1: 1, x2: 2, y2: 1, width: 1 }
  const right = { x1: 2, y1: 1, x2: 2, y2: 2, width: 1 }
  const bottom = { x1: 2, y1: 2, x2: 1, y2: 2, width: 1 }
  const left = { x1: 1, y1: 2, x2: 1, y2: 1, width: 1 }
  const box = { top, right, bottom, left }
  expect(inferBoxFromPartial({ left, top, right })).toEqual(box)
  expect(inferBoxFromPartial({ top, right, bottom })).toEqual(box)
  expect(inferBoxFromPartial({ right, bottom, left })).toEqual(box)
  expect(inferBoxFromPartial({ bottom, left, top })).toEqual(box)
})

test('infer two box sides', () => {
  const top = { x1: 1, y1: 1, x2: 2, y2: 1, width: 1 }
  const right = { x1: 2, y1: 1, x2: 2, y2: 2, width: 1 }
  const bottom = { x1: 2, y1: 2, x2: 1, y2: 2, width: 1 }
  const left = { x1: 1, y1: 2, x2: 1, y2: 1, width: 1 }
  const box = { top, right, bottom, left }
  expect(inferBoxFromPartial({ left, top })).toEqual(box)
  expect(inferBoxFromPartial({ top, right })).toEqual(box)
  expect(inferBoxFromPartial({ right, bottom })).toEqual(box)
  expect(inferBoxFromPartial({ bottom, left })).toEqual(box)
})
