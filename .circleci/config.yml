# THIS FILE IS GENERATED. DO NOT EDIT IT DIRECTLY.
# Run `pnpm -w generate-circleci-config` to regenerate it.

version: 2.1

executors:
  nodejs:
    docker:
      - image: votingworks/cimg-debian12:4.2.0
        auth:
          username: $VX_DOCKER_USERNAME
          password: $VX_DOCKER_PASSWORD

  nodejs_postgres:
    docker:
      - image: votingworks/cimg-debian12:4.2.0
        auth:
          username: $VX_DOCKER_USERNAME
          password: $VX_DOCKER_PASSWORD

      - image: cimg/postgres:16.6
        environment:
          POSTGRES_USER: postgres

jobs:
  # @votingworks/pollbook-backend
  test-apps-pollbook-backend:
    executor: nodejs
    resource_class: xlarge
    steps:
      - checkout-and-install:
          is_node_package: true
      - run:
          name: Build
          command: |
            pnpm --dir apps/pollbook/backend build
      - run:
          name: Lint
          command: |
            pnpm --dir apps/pollbook/backend lint
      - run:
          name: Test 10 Times
          command: |
            for i in $(seq 1 10); do
              echo "Run #$i"
              pnpm --dir apps/pollbook/backend test || exit 1
            done
          environment:
            JEST_JUNIT_OUTPUT_DIR: ./reports/
      - store_test_results:
          path: apps/pollbook/backend/reports/
      - store_artifacts:
          path: apps/pollbook/backend/src/__image_snapshots__/__diff_output__/

  test-crate-vx-logging:
    executor: 'nodejs'
    resource_class: xlarge
    steps:
      - checkout-and-install:
          is_node_package: false
      - run:
          name: Build
          command: |
            cargo build -p vx-logging
      - run:
          name: Lint
          command: |
            cargo clippy -p vx-logging
      - run:
          name: Test
          command: |
            cargo test -p vx-logging

  validate-monorepo:
    executor: nodejs
    resource_class: xlarge
    steps:
      - checkout-and-install:
          is_node_package: true
      - run:
          name: Build
          command: |
            pnpm --dir script build
      - run:
          name: Validate
          command: |
            ./script/validate-monorepo

workflows:
  test:
    jobs:
      - test-apps-admin-backend
      - test-apps-admin-frontend
      - test-apps-admin-integration-testing
      - test-apps-central-scan-backend
      - test-apps-central-scan-frontend
      - test-apps-central-scan-integration-testing
      - test-apps-design-backend
      - test-apps-design-frontend
      - test-apps-mark-scan-backend
      - test-apps-mark-scan-frontend
      - test-apps-mark-scan-integration-testing
      - test-apps-mark-backend
      - test-apps-mark-frontend
      - test-apps-mark-integration-testing
      - test-apps-pollbook-backend
      - test-apps-pollbook-frontend
      - test-apps-scan-backend
      - test-apps-scan-frontend
      - test-docs-exercises
      - test-libs-api
      - test-libs-auth
      - test-libs-backend
      - test-libs-ballot-encoder
      - test-libs-ballot-interpreter
      - test-libs-basics
      - test-libs-bmd-ballot-fixtures
      - test-libs-cdf-schema-builder
      - test-libs-custom-paper-handler
      - test-libs-custom-scanner
      - test-libs-db
      - test-libs-dev-dock-backend
      - test-libs-dev-dock-frontend
      - test-libs-eslint-plugin-vx
      - test-libs-fixture-generators
      - test-libs-fixtures
      - test-libs-fs
      - test-libs-fujitsu-thermal-printer
      - test-libs-grout
      - test-libs-grout-test-utils
      - test-libs-hardware-scan-diagnostic
      - test-libs-hmpb
      - test-libs-image-utils
      - test-libs-logging
      - test-libs-logging-utils
      - test-libs-mark-flow-ui
      - test-libs-message-coder
      - test-libs-monorepo-utils
      - test-libs-pdi-scanner
      - test-libs-printing
      - test-libs-test-utils
      - test-libs-types
      - test-libs-types-rs
      - test-libs-ui
      - test-libs-usb-drive
      - test-libs-utils
      - test-crate-ballot-interpreter
      - test-crate-controllerd
      - test-crate-daemon-utils
      - test-crate-fai100-controllerd
      - test-crate-hardware-scan-diagnostic
      - test-crate-logging-utils
      - test-crate-patinputd
      - test-crate-pdi-scanner
      - test-crate-types-rs
      - test-crate-vx-logging
      - validate-monorepo

commands:
  checkout-and-install:
    description: Get the code and install dependencies.
    parameters:
      is_node_package:
        type: boolean
    steps:
      - run:
          name: Ensure rust is in the PATH variable
          command: |
            echo 'export PATH="/root/.cargo/bin:$PATH"' >> $BASH_ENV
      - checkout
      # Edit this comment somehow in order to invalidate the CircleCI cache.
      # Since the contents of this file affect the cache key, editing only a
      # comment will invalidate the cache without changing the behavior.
      # last edited by Kofi 2024-09-19
      - when:
          condition: << parameters.is_node_package >>
          steps:
            - restore_cache:
                name: Restore Node.js Cache
                key:
                  pnpm-cache-{{checksum ".circleci/config.yml" }}-{{ checksum
                  "pnpm-lock.yaml" }}
            - run:
                name: Install Node.js Dependencies
                command: pnpm install --frozen-lockfile
            - save_cache:
                name: Save Node.js Cache
                key:
                  pnpm-cache-{{checksum ".circleci/config.yml" }}-{{ checksum
                  "pnpm-lock.yaml" }}
                paths:
                  - /root/.local/share/pnpm/store/v3
                  - /root/.cache/ms-playwright
      - restore_cache:
          name: Restore Cargo Cache
          key:
            cargo-cache-{{checksum ".circleci/config.yml" }}-{{ checksum
            "Cargo.lock" }}
      - run:
          name: Install Rust Dependencies
          command: pnpm --recursive install:rust-addon
      - save_cache:
          name: Save Cargo Cache
          key:
            cargo-cache-{{checksum ".circleci/config.yml" }}-{{ checksum
            "Cargo.lock" }}
          paths:
            - /root/.cargo
