# THIS FILE IS GENERATED. DO NOT EDIT IT DIRECTLY.
# Run `pnpm -w generate-circleci-config` to regenerate it.

version: 2.1

executors:
  nodejs:
    docker:
      - image: votingworks/cimg-debian12:4.2.0
        auth:
          username: $VX_DOCKER_USERNAME
          password: $VX_DOCKER_PASSWORD

  nodejs_postgres:
    docker:
      - image: votingworks/cimg-debian12:4.2.0
        auth:
          username: $VX_DOCKER_USERNAME
          password: $VX_DOCKER_PASSWORD

      - image: cimg/postgres:16.6
        environment:
          POSTGRES_USER: postgres

jobs:
  # @votingworks/pollbook-backend
  test-apps-pollbook-backend:
    executor: nodejs
    resource_class: xlarge
    steps:
      - checkout-and-install:
          is_node_package: true
      - run:
          name: Build
          command: |
            pnpm --dir apps/pollbook/backend build
      - run:
          name: Lint
          command: |
            pnpm --dir apps/pollbook/backend lint
      - run:
          name: Test 10 Times
          command: |
            for i in $(seq 1 10); do
              echo "Run #$i"
              pnpm --dir apps/pollbook/backend test || exit 1
            done
          environment:
            JEST_JUNIT_OUTPUT_DIR: ./reports/
      - store_test_results:
          path: apps/pollbook/backend/reports/
      - store_artifacts:
          path: apps/pollbook/backend/src/__image_snapshots__/__diff_output__/

  test-crate-vx-logging:
    executor: 'nodejs'
    resource_class: xlarge
    steps:
      - checkout-and-install:
          is_node_package: false
      - run:
          name: Build
          command: |
            cargo build -p vx-logging
      - run:
          name: Lint
          command: |
            cargo clippy -p vx-logging
      - run:
          name: Test
          command: |
            cargo test -p vx-logging

  validate-monorepo:
    executor: nodejs
    resource_class: xlarge
    steps:
      - checkout-and-install:
          is_node_package: true
      - run:
          name: Build
          command: |
            pnpm --dir script build
      - run:
          name: Validate
          command: |
            ./script/validate-monorepo

workflows:
  test:
    jobs:
      - test-apps-pollbook-backend

commands:
  checkout-and-install:
    description: Get the code and install dependencies.
    parameters:
      is_node_package:
        type: boolean
    steps:
      - run:
          name: Ensure rust is in the PATH variable
          command: |
            echo 'export PATH="/root/.cargo/bin:$PATH"' >> $BASH_ENV
      - checkout
      # Edit this comment somehow in order to invalidate the CircleCI cache.
      # Since the contents of this file affect the cache key, editing only a
      # comment will invalidate the cache without changing the behavior.
      # last edited by Kofi 2024-09-19
      - when:
          condition: << parameters.is_node_package >>
          steps:
            - restore_cache:
                name: Restore Node.js Cache
                key:
                  pnpm-cache-{{checksum ".circleci/config.yml" }}-{{ checksum
                  "pnpm-lock.yaml" }}
            - run:
                name: Install Node.js Dependencies
                command: pnpm install --frozen-lockfile
            - save_cache:
                name: Save Node.js Cache
                key:
                  pnpm-cache-{{checksum ".circleci/config.yml" }}-{{ checksum
                  "pnpm-lock.yaml" }}
                paths:
                  - /root/.local/share/pnpm/store/v3
                  - /root/.cache/ms-playwright
      - restore_cache:
          name: Restore Cargo Cache
          key:
            cargo-cache-{{checksum ".circleci/config.yml" }}-{{ checksum
            "Cargo.lock" }}
      - run:
          name: Install Rust Dependencies
          command: pnpm --recursive install:rust-addon
      - save_cache:
          name: Save Cargo Cache
          key:
            cargo-cache-{{checksum ".circleci/config.yml" }}-{{ checksum
            "Cargo.lock" }}
          paths:
            - /root/.cargo
